<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Despesas Compartilhadas - Pagae</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root{
            --corprincipal: #01395A;
            --corsecundaria: #0098A5;
        }
        .page { display: none; }
        .page.active { display: block; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-[var(--corprincipal)] min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-[var(--corprincipal)]">üí∞ Pagae</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="showPage('users')" class="nav-btn px-4 py-2 rounded-lg hover:bg-[var(--corsecundaria)] hover:text-white transition">Usu√°rios</button>
                    <button onclick="showPage('groups')" class="nav-btn px-4 py-2 rounded-lg hover:bg-[var(--corsecundaria)] hover:text-white transition">Grupos</button>
                    <button onclick="showPage('expenses')" class="nav-btn px-4 py-2 rounded-lg hover:bg-[var(--corsecundaria)] hover:text-white transition">Despesas</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- P√ÅGINA: USU√ÅRIOS -->
        <div id="users" class="page active fade-in">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">üë• Gerenciar Usu√°rios</h2>
                
                <div class="bg-[var(--corsecundaria)] rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-white mb-4">Novo Usu√°rio</h3>
                    <form onsubmit="createUser(event)" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="text" id="userName" placeholder="Nome" required 
                               class="px-4 py-2 rounded-lg border focus:ring-2 focus:ring-[var(--corprincipal)] outline-none">
                        <input type="email" id="userEmail" placeholder="Email" required 
                               class="px-4 py-2 rounded-lg border focus:ring-2 focus:ring-[var(--corprincipal)] outline-none">
                        <input type="password" id="userPassword" placeholder="Senha" required 
                               class="px-4 py-2 rounded-lg border focus:ring-2 focus:ring-[var(--corprincipal)] outline-none">
                        <button type="submit" class="bg-white text-[var(--corprincipal)] font-semibold px-6 py-2 rounded-lg hover:bg-gray-100 transition">
                            Adicionar
                        </button>
                    </form>
                </div>
                
                <div id="usersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>

        <!-- P√ÅGINA: GRUPOS -->
        <div id="groups" class="page">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Gerenciar Grupos</h2>
                
                <div class="bg-[var(--corsecundaria)] rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-white mb-4">Novo Grupo</h3>
                    <form onsubmit="createGroup(event)" class="flex gap-4">
                        <input type="text" id="groupName" placeholder="Nome do Grupo (ex: Churras da Firma)" required 
                               class="flex-1 px-4 py-2 rounded-lg border focus:ring-2 focus:ring-teal-300 outline-none">
                        <button type="submit" class="bg-white text-[var(--corsecundaria)] font-semibold px-6 py-2 rounded-lg hover:bg-gray-100 transition">
                            Criar Grupo
                        </button>
                    </form>
                </div>
                
                <div id="groupsList" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </div>
        </div>

        <!-- P√ÅGINA: DESPESAS -->
        <div id="expenses" class="page">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">üí∏ Gerenciar Despesas</h2>
                
                <div class="bg-[var(--corsecundaria)] rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-white mb-4">Nova Despesa</h3>
                    <form onsubmit="createExpense(event)" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <select id="expenseGroup" required class="px-4 py-2 rounded-lg border focus:ring-2 focus:ring-red-300 outline-none">
                            <option value="">Selecione o Grupo</option>
                        </select>
                        <select id="expensePayer" required disabled class="px-4 py-2 rounded-lg border focus:ring-2 focus:ring-red-300 outline-none bg-gray-100">
                            <option value="">Primeiro selecione o grupo</option>
                        </select>
                        <input type="text" id="expenseDescription" placeholder="Descri√ß√£o (ex: Pizza)" required 
                               class="px-4 py-2 rounded-lg border focus:ring-2 focus:ring-red-300 outline-none">
                        <input type="number" id="expenseAmount" placeholder="Valor (R$)" step="0.01" required 
                               class="px-4 py-2 rounded-lg border focus:ring-2 focus:ring-red-300 outline-none">
                        <button type="submit" class="bg-white text-[var(--corprincipal)] font-semibold px-6 py-2 rounded-lg hover:bg-gray-100 transition">
                            Adicionar
                        </button>
                    </form>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">Filtrar por Grupo:</label>
                    <select id="filterGroup" onchange="loadExpenses()" class="w-full md:w-64 px-4 py-2 rounded-lg border focus:ring-2 focus:ring-indigo-300 outline-none">
                        <option value="">Todos os Grupos</option>
                    </select>
                </div>
                
                <div id="expensesList" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar Membros -->
    <div id="memberModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Adicionar Membro</h3>
            <form onsubmit="addMemberToGroup(event)">
                <input type="hidden" id="modalGroupId">
                <select id="modalUserId" required class="w-full px-4 py-2 rounded-lg border focus:ring-2 focus:ring-indigo-300 outline-none mb-4">
                    <option value="">Selecione um usu√°rio</option>
                </select>
                <div class="flex gap-3">
                    <button type="button" onclick="closeMemberModal()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        Adicionar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8080';
        let currentGroupId = null;

        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageName).classList.add('active');
            
            if (pageName === 'users') loadUsers();
            if (pageName === 'groups') loadGroups();
            if (pageName === 'expenses') {
                loadGroupsForExpenses();
                loadExpenses();
            }
        }

        // ========== USU√ÅRIOS ==========
        async function loadUsers() {
            try {
                const response = await fetch(`${API_URL}/users`);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const users = await response.json();
                
                const usersList = document.getElementById('usersList');
                usersList.innerHTML = users.map(user => `
                    <div class="bg-gradient-to-br from-white to-indigo-50 border border-indigo-200 rounded-lg p-4 hover:shadow-lg transition">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-lg text-gray-800">${user.name}</h4>
                            <button onclick="deleteUser(${user.id})" class="text-red-500 hover:text-red-700">
                                üóëÔ∏è
                            </button>
                        </div>
                        <p class="text-gray-600 text-sm">üìß ${user.email}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                alert('Erro ao carregar usu√°rios: ' + error.message);
            }
        }

        async function createUser(event) {
            event.preventDefault();
            const user = {
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                password: document.getElementById('userPassword').value
            };
            
            try {
                const response = await fetch(`${API_URL}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(user)
                });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                event.target.reset();
                loadUsers();
                alert('‚úÖ Usu√°rio criado com sucesso!');
            } catch (error) {
                console.error('Erro ao criar usu√°rio:', error);
                alert('Erro ao criar usu√°rio: ' + error.message);
            }
        }

        async function deleteUser(id) {
            if (!confirm('Tem certeza que deseja excluir este usu√°rio?')) return;
            
            try {
                const response = await fetch(`${API_URL}/users/${id}`, { method: 'DELETE' });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                loadUsers();
                alert('‚úÖ Usu√°rio exclu√≠do com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir usu√°rio:', error);
                alert('Erro ao excluir usu√°rio: ' + error.message);
            }
        }

        // ========== GRUPOS ==========
        async function loadGroups() {
            try {
                const response = await fetch(`${API_URL}/groups`);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const groups = await response.json();
                
                if (!Array.isArray(groups)) {
                    console.error('Groups n√£o √© um array:', groups);
                    document.getElementById('groupsList').innerHTML = `
                        <div class="col-span-2 text-center py-8">
                            <p class="text-red-500">Erro: Dados de grupos inv√°lidos</p>
                        </div>
                    `;
                    return;
                }
                
                if (groups.length === 0) {
                    document.getElementById('groupsList').innerHTML = `
                        <div class="col-span-2 text-center py-8">
                            <p class="text-gray-500">Nenhum grupo cadastrado</p>
                        </div>
                    `;
                    return;
                }

                const groupsList = document.getElementById('groupsList');
                const groupsHTML = await Promise.all(groups.map(async group => {
                    try {
                        const membersRes = await fetch(`${API_URL}/groups/${group.id}/members`);
                        
                        if (!membersRes.ok) {
                            throw new Error(`Erro ao carregar membros: ${membersRes.status}`);
                        }
                        
                        const members = await membersRes.json();
                        const membersArray = Array.isArray(members) ? members : [];
                        
                        return `
                            <div class="bg-gradient-to-br from-white to-green-50 border border-green-200 rounded-lg p-5 hover:shadow-lg transition">
                                <div class="flex justify-between items-start mb-3">
                                    <h4 class="font-bold text-xl text-gray-800">${group.name || 'Grupo sem nome'}</h4>
                                    <button onclick="deleteGroup(${group.id})" 
                                            class="text-red-500 hover:text-red-700 transition p-2 hover:bg-red-50 rounded"
                                            title="Excluir grupo">
                                        üóëÔ∏è
                                    </button>
                                </div>
                                
                                <div class="mb-3">
                                    <p class="text-sm font-semibold text-gray-600 mb-2">Membros (${membersArray.length}):</p>
                                    <div class="space-y-1">
                                        ${membersArray.length > 0 
                                            ? membersArray.map(m => `
                                                <div class="text-sm text-gray-700 bg-white rounded px-2 py-1">
                                                    üë§ ${m.user?.name || 'Usu√°rio sem nome'}
                                                </div>
                                            `).join('')
                                            : '<p class="text-sm text-gray-500">Nenhum membro</p>'
                                        }
                                    </div>
                                </div>
                                
                                <button onclick="openMemberModal(${group.id})" 
                                        class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                                    + Adicionar Membro
                                </button>
                            </div>
                        `;
                    } catch (memberError) {
                        console.error(`Erro ao carregar membros do grupo ${group.id}:`, memberError);
                        return `
                            <div class="bg-gradient-to-br from-white to-red-50 border border-red-200 rounded-lg p-5">
                                <div class="flex justify-between items-start mb-3">
                                    <h4 class="font-bold text-xl text-gray-800">${group.name || 'Grupo sem nome'}</h4>
                                    <button onclick="deleteGroup(${group.id})" 
                                            class="text-red-500 hover:text-red-700 transition p-2"
                                            title="Excluir grupo">
                                        üóëÔ∏è
                                    </button>
                                </div>
                                <p class="text-red-500">Erro ao carregar membros</p>
                            </div>
                        `;
                    }
                }));
                
                groupsList.innerHTML = groupsHTML.join('');
            } catch (error) {
                console.error('Erro ao carregar grupos:', error);
                document.getElementById('groupsList').innerHTML = `
                    <div class="col-span-2 text-center py-8">
                        <p class="text-red-500">Erro ao carregar grupos</p>
                        <p class="text-gray-500 text-sm">${error.message}</p>
                    </div>
                `;
            }
        }

        async function createGroup(event) {
            event.preventDefault();
            const group = { name: document.getElementById('groupName').value };
            
            try {
                const response = await fetch(`${API_URL}/groups`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(group)
                });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                event.target.reset();
                loadGroups();
                alert('‚úÖ Grupo criado com sucesso!');
            } catch (error) {
                console.error('Erro ao criar grupo:', error);
                alert('Erro ao criar grupo: ' + error.message);
            }
        }

        async function deleteGroup(groupId) {
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja excluir este grupo?\n\nIsso tamb√©m excluir√° todas as despesas e membros associados!')) return;
            
            try {
                const response = await fetch(`${API_URL}/groups/delete_group/${groupId}`, { 
                    method: 'DELETE' 
                });
                
                if (!response.ok) {
                    throw new Error(`Erro ao excluir: ${response.status}`);
                }
                
                loadGroups();
                loadGroupsForExpenses();
                alert('‚úÖ Grupo exclu√≠do com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir grupo:', error);
                alert('‚ùå Erro ao excluir grupo: ' + error.message);
            }
        }

        async function openMemberModal(groupId) {
            currentGroupId = groupId;
            document.getElementById('modalGroupId').value = groupId;
            
            try {
                const response = await fetch(`${API_URL}/users`);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const users = await response.json();
                
                const select = document.getElementById('modalUserId');
                select.innerHTML = '<option value="">Selecione um usu√°rio</option>' +
                    users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
                
                document.getElementById('memberModal').classList.remove('hidden');
                document.getElementById('memberModal').classList.add('flex');
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                alert('Erro ao carregar usu√°rios: ' + error.message);
            }
        }

        function closeMemberModal() {
            document.getElementById('memberModal').classList.add('hidden');
            document.getElementById('memberModal').classList.remove('flex');
        }

        async function addMemberToGroup(event) {
            event.preventDefault();
            const groupId = document.getElementById('modalGroupId').value;
            const userId = document.getElementById('modalUserId').value;
            
            try {
                const response = await fetch(`${API_URL}/groups/${groupId}/members`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId })
                });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                closeMemberModal();
                loadGroups();
                alert('‚úÖ Membro adicionado com sucesso!');
            } catch (error) {
                console.error('Erro ao adicionar membro:', error);
                alert('Erro ao adicionar membro: ' + error.message);
            }
        }

        // ========== DESPESAS ==========
        async function loadGroupsForExpenses() {
            try {
                const response = await fetch(`${API_URL}/groups`);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const groups = await response.json();
                
                if (!Array.isArray(groups)) {
                    console.error('Groups n√£o √© um array:', groups);
                    return;
                }
                
                const expenseGroupSelect = document.getElementById('expenseGroup');
                const filterGroupSelect = document.getElementById('filterGroup');
                
                expenseGroupSelect.innerHTML = '<option value="">Selecione o Grupo</option>' +
                    groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
                
                filterGroupSelect.innerHTML = '<option value="">Todos os Grupos</option>' +
                    groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
                
                expenseGroupSelect.addEventListener('change', loadMembersOfSelectedGroup);
            } catch (error) {
                console.error('Erro ao carregar grupos:', error);
            }
        }

        async function loadMembersOfSelectedGroup() {
            const groupId = document.getElementById('expenseGroup').value;
            const payerSelect = document.getElementById('expensePayer');
            
            if (!groupId) {
                payerSelect.disabled = true;
                payerSelect.innerHTML = '<option value="">Primeiro selecione o grupo</option>';
                payerSelect.classList.add('bg-gray-100');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/groups/${groupId}/members`);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const members = await response.json();
                
                payerSelect.disabled = false;
                payerSelect.classList.remove('bg-gray-100');
                
                if (members.length === 0) {
                    payerSelect.innerHTML = '<option value="">Este grupo n√£o tem membros</option>';
                    payerSelect.disabled = true;
                } else {
                    payerSelect.innerHTML = '<option value="">Quem Pagou?</option>' +
                        members.map(m => `<option value="${m.user.id}">${m.user.name}</option>`).join('');
                }
            } catch (error) {
                console.error('Erro ao carregar membros:', error);
                alert('Erro ao carregar membros: ' + error.message);
                payerSelect.disabled = true;
                payerSelect.innerHTML = '<option value="">Erro ao carregar membros</option>';
            }
        }

        async function loadExpenses() {
            const filterGroupId = document.getElementById('filterGroup').value;
            
            try {
                let expenses = [];
                
                if (filterGroupId) {
                    const response = await fetch(`${API_URL}/expenses/group/${filterGroupId}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        expenses = Array.isArray(data) ? data : [];
                    }
                } else {
                    const groupsRes = await fetch(`${API_URL}/groups`);
                    
                    if (groupsRes.ok) {
                        const groups = await groupsRes.json();
                        
                        if (Array.isArray(groups)) {
                            for (const group of groups) {
                                try {
                                    const expensesRes = await fetch(`${API_URL}/expenses/group/${group.id}`);
                                    
                                    if (expensesRes.ok) {
                                        const groupExpenses = await expensesRes.json();
                                        
                                        if (Array.isArray(groupExpenses)) {
                                            expenses = [...expenses, ...groupExpenses];
                                        }
                                    }
                                } catch (error) {
                                    console.error(`Erro ao carregar despesas do grupo ${group.id}:`, error);
                                }
                            }
                        }
                    }
                }
                
                const expensesList = document.getElementById('expensesList');
                
                if (expenses.length === 0) {
                    expensesList.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhuma despesa registrada</p>';
                } else {
                    expensesList.innerHTML = expenses.map(exp => `
                        <div class="bg-gradient-to-r from-white to-orange-50 border border-orange-200 rounded-lg p-5 hover:shadow-lg transition">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h4 class="font-bold text-xl text-gray-800">${exp.description}</h4>
                                    <p class="text-sm text-gray-600">Pago por: ${exp.payer?.name || 'N/A'}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-2xl font-bold text-orange-600">R$ ${parseFloat(exp.amount).toFixed(2)}</p>
                                </div>
                            </div>
                            <div class="border-t pt-3">
                                <p class="text-sm font-semibold text-gray-600 mb-2">Divis√£o:</p>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                    ${exp.splits && Array.isArray(exp.splits) && exp.splits.length > 0 
                                        ? exp.splits.map(s => `
                                            <div class="bg-white rounded px-3 py-2 text-sm">
                                                <p class="font-semibold">${s.user?.name || 'N/A'}</p>
                                                <p class="text-orange-600">R$ ${parseFloat(s.amount).toFixed(2)}</p>
                                            </div>
                                        `).join('')
                                        : '<p class="text-gray-500 text-sm col-span-3">Sem divis√£o</p>'
                                    }
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Erro ao carregar despesas:', error);
                document.getElementById('expensesList').innerHTML = `
                    <p class="text-center text-red-500 py-8">Erro ao carregar despesas</p>
                    <p class="text-center text-gray-500 text-sm">${error.message}</p>
                `;
            }
        }

        async function createExpense(event) {
            event.preventDefault();
            const expense = {
                groupId: document.getElementById('expenseGroup').value,
                payerId: document.getElementById('expensePayer').value,
                description: document.getElementById('expenseDescription').value,
                amount: document.getElementById('expenseAmount').value
            };
            
            try {
                const response = await fetch(`${API_URL}/expenses`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(expense)
                });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                event.target.reset();
                
                const payerSelect = document.getElementById('expensePayer');
                payerSelect.disabled = true;
                payerSelect.innerHTML = '<option value="">Primeiro selecione o grupo</option>';
                payerSelect.classList.add('bg-gray-100');
                
                loadExpenses();
                alert('‚úÖ Despesa criada e dividida com sucesso!');
            } catch (error) {
                console.error('Erro ao criar despesa:', error);
                alert('Erro ao criar despesa: ' + error.message);
            }
        }

        // Inicializa√ß√£o
        loadUsers();
    </script>
</body>
</html>